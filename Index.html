<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coffee Shop — Live Orders Dashboard (CSV Upload)</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            coffee: {
              50: '#f7f3ef', 100: '#efe7df', 200: '#e0cfc0', 300: '#d0b7a0',
              400: '#c19f81', 500: '#b18761', 600: '#8e6c4e', 700: '#6b513b',
              800: '#483628', 900: '#251b14'
            }
          },
          boxShadow: {
            soft: '0 10px 25px -10px rgba(0,0,0,0.25)'
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #6b513b; }
    html, body { height: 100%; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; }
    .glass { backdrop-filter: blur(8px); }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .toast-enter { animation: toastIn 250ms ease-out both; }
    @keyframes toastIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    details > summary::-webkit-details-marker { display: none; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-coffee-50 to-white text-coffee-900">
  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white/80 glass border-b border-coffee-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-coffee-700 text-white grid place-items-center shadow-soft">☕</div>
        <div>
          <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight">Live Orders Dashboard</h1>
          <p class="text-sm text-coffee-700/70">Manage orders in real-time • Coffee, pastries & snacks</p>
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-2 sm:gap-3">
        <button id="addOrderBtn" class="px-3 sm:px-4 py-2 rounded-xl bg-coffee-700 text-white hover:bg-coffee-800 transition shadow-soft text-sm font-semibold">+ Add Demo Order</button>
        <button id="add5Btn" class="px-3 sm:px-4 py-2 rounded-xl bg-coffee-100 text-coffee-800 hover:bg-coffee-200 transition text-sm font-semibold">+5 Quick Add</button>

        <!-- Upload CSV -->
        <input id="csvInput" type="file" accept=".csv" class="hidden" />
        <button id="uploadCsvBtn" class="px-3 sm:px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 transition shadow-soft text-sm font-semibold">Upload CSV</button>
        <button id="resetDataBtn" class="px-3 sm:px-4 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 transition shadow-soft text-sm font-semibold">Reset Data</button>

        <div class="hidden sm:flex items-center gap-2">
          <label for="autoRefresh" class="text-sm font-medium">Auto‑refresh</label>
          <select id="autoRefresh" class="px-3 py-2 rounded-xl border border-coffee-200 bg-white text-sm">
            <option value="0">Off</option>
            <option value="5000">Every 5s</option>
            <option value="10000" selected>Every 10s</option>
            <option value="30000">Every 30s</option>
            <option value="60000">Every 60s</option>
          </select>
          <button id="refreshNow" class="px-3 py-2 rounded-xl border border-coffee-300 text-sm hover:bg-coffee-50">Refresh now</button>
        </div>
      </div>
    </div>

    <!-- Import Summary Toast / Banner -->
    <div id="importToast" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-3">
      <div class="toast-enter p-4 rounded-2xl border shadow-soft bg-emerald-50 border-emerald-200 text-emerald-900 flex items-start justify-between gap-4">
        <div>
          <p id="importHeadline" class="font-bold">Imported 0 orders, skipped 0 invalid rows.</p>
          <details id="errorDetails" class="mt-2">
            <summary class="cursor-pointer select-none inline-flex items-center gap-2 text-sm font-semibold text-emerald-900/80 hover:underline">
              <span>Show errors</span>
            </summary>
            <ul id="errorList" class="mt-2 text-sm text-coffee-900 list-disc ml-6"></ul>
          </details>
        </div>
        <button id="dismissToast" class="text-sm px-3 py-2 rounded-xl border border-emerald-300 hover:bg-white">Dismiss</button>
      </div>
    </div>
  </header>

  <!-- Summary Bar -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="p-4 bg-white rounded-2xl shadow-soft border border-coffee-100">
        <p class="text-sm text-coffee-600">Total Orders</p>
        <p id="sumTotalOrders" class="text-2xl font-extrabold">0</p>
        <p id="sumReadyPending" class="text-xs text-coffee-600 mt-1">0 ready • 0 pending</p>
      </div>
      <div class="p-4 bg-white rounded-2xl shadow-soft border border-coffee-100">
        <p class="text-sm text-coffee-600">Revenue (Today)</p>
        <p id="sumRevenue" class="text-2xl font-extrabold">£0.00</p>
        <p id="sumAOV" class="text-xs text-coffee-600 mt-1">Avg order: £0.00</p>
      </div>
      <div class="p-4 bg-white rounded-2xl shadow-soft border border-coffee-100">
        <p class="text-sm text-coffee-600">Throughput</p>
        <p id="sumThroughput" class="text-2xl font-extrabold">0/hr</p>
        <p id="sumCurrentInterval" class="text-xs text-coffee-600 mt-1">Auto‑refresh: 10s</p>
      </div>
      <div class="p-4 bg-white rounded-2xl shadow-soft border border-coffee-100">
        <p class="text-sm text-coffee-600">Assistant</p>
        <p id="assistantHeadline" class="text-sm font-semibold text-coffee-900">Standing by…</p>
        <button id="runAssistant" class="mt-2 w-full px-3 py-2 rounded-xl bg-coffee-700 text-white text-sm font-semibold hover:bg-coffee-800">Run Smart Suggestions</button>
      </div>
    </div>
  </section>

  <!-- Alerts Panel -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
    <div class="p-4 bg-white rounded-2xl shadow-soft border border-amber-200">
      <div class="flex items-center justify-between">
        <h2 class="font-bold text-lg">Alerts</h2>
        <span id="alertCount" class="text-xs text-coffee-600">0 issues</span>
      </div>
      <div id="alertsList" class="mt-3 grid gap-2"></div>
    </div>
  </section>

  <!-- Orders Grid -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6 mb-24">
    <div id="ordersGrid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
  </main>

  <!-- Footer Controls (mobile auto‑refresh) -->
  <footer class="fixed bottom-0 inset-x-0 sm:hidden bg-white/90 glass border-t border-coffee-100 p-3">
    <div class="max-w-7xl mx-auto flex items-center justify-between gap-2">
      <div class="flex items-center gap-2">
        <label for="autoRefreshMobile" class="text-sm font-medium">Auto‑refresh</label>
        <select id="autoRefreshMobile" class="px-3 py-2 rounded-xl border border-coffee-200 bg-white text-sm">
          <option value="0">Off</option>
          <option value="5000">5s</option>
          <option value="10000" selected>10s</option>
          <option value="30000">30s</option>
          <option value="60000">60s</option>
        </select>
      </div>
      <button id="refreshNowMobile" class="px-3 py-2 rounded-xl border border-coffee-300 text-sm hover:bg-coffee-50">Refresh now</button>
    </div>
  </footer>

  <script>
    // ---------- Data & Utilities ----------
    const currency = (n) => `£${Number(n).toFixed(2)}`;
    const now = () => Date.now();
    const minutes = (m) => m*60*1000;
    const timeSince = (ts) => {
      const diff = Math.max(0, now() - ts);
      const s = Math.floor(diff/1000);
      if (s < 60) return `${s}s ago`;
      const m = Math.floor(s/60);
      if (m < 60) return `${m}m ago`;
      const h = Math.floor(m/60);
      return `${h}h ${m%60}m ago`;
    };

    const MENU = {
      drinks: [
        {name:'Espresso', price:2.2}, {name:'Americano', price:2.6}, {name:'Latte', price:3.2},
        {name:'Cappuccino', price:3.1}, {name:'Flat White', price:3.0}, {name:'Mocha', price:3.4},
        {name:'Iced Latte', price:3.4}, {name:'Hot Chocolate', price:3.0}, {name:'Chai Latte', price:3.2}
      ],
      pastries: [
        {name:'Croissant', price:2.1}, {name:'Almond Croissant', price:2.6}, {name:'Pain au Chocolat', price:2.4},
        {name:'Cinnamon Roll', price:2.5}, {name:'Blueberry Muffin', price:2.3}
      ],
      snacks: [
        {name:'Banana Bread', price:2.0}, {name:'Granola Bar', price:1.8}, {name:'Bagel', price:2.0},
        {name:'Cheese Toastie', price:3.8}, {name:'Ham & Cheese Panini', price:4.2}
      ]
    };

    const FIRST_NAMES = ['Alex','Sam','Jordan','Taylor','Morgan','Casey','Riley','Jamie','Avery','Cameron','Drew','Harper','Jules','Kiran','Sky'];
    const LAST_NAMES  = ['Lee','Patel','Smith','Garcia','Brown','Martin','Khan','Nguyen','Jones','Wilson','Singh','Wright'];
    const PAYMENTS    = ['Card','Cash','Mobile'];

    const randomOf = (arr) => arr[Math.floor(Math.random()*arr.length)];
    const randomName = () => `${randomOf(FIRST_NAMES)} ${randomOf(LAST_NAMES)}`;
    const uid = () => Math.random().toString(36).slice(2,9);

    const local = {
      get() { try { return JSON.parse(localStorage.getItem('orders_v2_csv')||'[]'); } catch { return []; } },
      set(data) { localStorage.setItem('orders_v2_csv', JSON.stringify(data)); }
    };

    // ---------- State ----------
    let orders = local.get();
    let intervalId = null;

    // order = { id, customer, items:[{name, type, price}], status:'waiting'|'in_progress'|'ready'|'cancelled', payment, ts, total }

    function calcTotal(items){ return items.reduce((a,i)=>a+Number(i.price||0),0); }

    function randomItems(){
      const groups = ['drinks','pastries','snacks'];
      const items = [];
      const count = Math.ceil(Math.random()*5); // 1..5
      for(let i=0;i<count;i++){
        const g = randomOf(groups);
        const menuItem = {...randomOf(MENU[g])};
        menuItem.type = g;
        items.push(menuItem);
      }
      return items;
    }

    function addDemoOrder(){
      const items = randomItems();
      const order = {
        id: uid(),
        customer: randomName(),
        items,
        status: 'waiting',
        payment: randomOf(PAYMENTS),
        ts: now() - Math.floor(Math.random()*minutes(8)), // some orders already waiting a bit
        total: calcTotal(items)
      };
      orders.unshift(order);
      persistAndRender();
    }

    function addMany(n=5){ for(let i=0;i<n;i++) addDemoOrder(); }

    function updateStatus(id, newStatus){
      const o = orders.find(x=>x.id===id);
      if(!o) return;
      o.status = newStatus;
      if(newStatus==='cancelled') o.cancelledAt = now();
      if(newStatus==='ready') o.readyAt = now();
      persistAndRender();
    }

    function cancelOrder(id){
      const o = orders.find(x=>x.id===id);
      if(!o) return;
      o.status = 'cancelled';
      o.cancelledAt = now();
      persistAndRender();
    }

    function removeOrder(id){
      orders = orders.filter(x=>x.id!==id);
      persistAndRender();
    }

    function persistAndRender(){ local.set(orders); renderAll(); }

    // ---------- CSV Import ----------
    const REQUIRED_COLS = ['customer_name','items','status','payment_method','timestamp','price_total'];
    const VALID_STATUS = new Set(['waiting','in progress','in_progress','ready','cancelled']);
    const VALID_PAY = new Set(['cash','card','upi','wallet']);

    function parseCSV(text){
      // Simple CSV parser that handles quoted fields and commas
      // For robustness, we use a regex-based split per line respecting quotes
      const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim().length>0);
      if(lines.length===0) return { rows: [], header: [] };
      const header = splitCSVLine(lines[0]).map(h=>h.trim());
      const rows = lines.slice(1).map(splitCSVLine);
      return { header, rows };
    }

    function splitCSVLine(line){
      const out = [];
      let cur = '';
      let inQ = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch==='"'){
          if(inQ && line[i+1]==='"'){ cur+='"'; i++; }
          else { inQ = !inQ; }
        } else if(ch===',' && !inQ){ out.push(cur); cur=''; }
        else { cur+=ch; }
      }
      out.push(cur);
      return out;
    }

    function mapHeaderIdx(header){
      const idx = {};
      header.forEach((h,i)=>{ idx[h.trim().toLowerCase()] = i; });
      return idx;
    }

    function toInternalStatus(s){
      const t = String(s||'').trim().toLowerCase();
      if(t==='in progress') return 'in_progress';
      if(t==='in_progress') return 'in_progress';
      if(t==='waiting' || t==='ready' || t==='cancelled') return t;
      return null;
    }

    function normalizePayment(p){
      const t = String(p||'').trim().toLowerCase();
      if(!VALID_PAY.has(t)) return null;
      // Display in nice case; keep original semantic
      if(t==='upi') return 'UPI';
      if(t==='cash') return 'Cash';
      if(t==='card') return 'Card';
      if(t==='wallet') return 'Wallet';
      return p;
    }

    function parseTimestamp(val){
      if(!val) return NaN;
      let s = String(val).trim();
      let d = new Date(s);
      if(isNaN(d.getTime())){
        // Try YYYY-MM-DD HH:MM -> replace space with T
        if(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}(:\d{2})?/.test(s)){
          d = new Date(s.replace(' ', 'T'));
        }
      }
      return d.getTime();
    }

    function importCSVText(text){
      const { header, rows } = parseCSV(text);
      if(header.length===0){ showImportToast(0, rows.length, ['Missing header row.']); return; }
      const idx = mapHeaderIdx(header);
      const missingCols = REQUIRED_COLS.filter(c=> !(c in idx));
      if(missingCols.length){ showImportToast(0, rows.length, [`Missing required columns: ${missingCols.join(', ')}`]); return; }

      const newOrders = [];
      const errors = [];

      rows.forEach((cols, rIdx)=>{
        const rowNum = rIdx + 2; // 1-based incl header
        function col(name){ return (cols[idx[name]]||'').trim(); }

        // Required checks
        const customer = col('customer_name');
        const itemsRaw = col('items');
        const statusRaw = col('status');
        const payRaw = col('payment_method');
        const tsRaw = col('timestamp');
        const totalRaw = col('price_total');

        const rowErrors = [];
        if(!customer) rowErrors.push('missing customer_name');
        if(!itemsRaw) rowErrors.push('missing items');
        if(!statusRaw) rowErrors.push('missing status');
        if(!payRaw) rowErrors.push('missing payment_method');
        if(!tsRaw) rowErrors.push('missing timestamp');
        if(!totalRaw) rowErrors.push('missing price_total');

        // Early short-circuit if any required missing
        if(rowErrors.length===0){
          // Validate dictionaries
          if(!VALID_STATUS.has(String(statusRaw).trim().toLowerCase())) rowErrors.push(`invalid status "${statusRaw}"`);
          const status = toInternalStatus(statusRaw);
          const pay = normalizePayment(payRaw);
          if(!pay) rowErrors.push(`invalid payment_method "${payRaw}"`);

          // Validate timestamp
          const ts = parseTimestamp(tsRaw);
          if(Number.isNaN(ts)) rowErrors.push(`invalid timestamp "${tsRaw}"`);

          // Validate price_total numeric
          const total = Number(String(totalRaw).replace(/[^0-9.\-]/g,''));
          if(!Number.isFinite(total)) rowErrors.push(`non-numeric price_total "${totalRaw}"`);

          // Build items array (names only; price unknown from CSV — leave price 0 for display)
          const items = itemsRaw.split(',').map(s=>s.trim()).filter(Boolean).map(name=>({ name, type:'unknown', price:0 }));

          if(rowErrors.length===0){
            newOrders.push({
              id: uid(),
              customer: customer,
              items,
              status,
              payment: pay,
              ts,
              total
            });
          }
        }

        if(rowErrors.length>0){ errors.push(`Row ${rowNum}: ${rowErrors.join('; ')}`); }
      });

      if(newOrders.length===0){
        showImportToast(0, rows.length, errors.length? errors : ['All rows invalid. Existing data unchanged.']);
        return; // keep existing data unchanged
      }

      // Merge: imported orders should appear at top
      orders = [...newOrders, ...orders];
      persistAndRender();
      showImportToast(newOrders.length, errors.length, errors);
    }

    function showImportToast(imported, skipped, errors){
      const wrap = document.getElementById('importToast');
      const head = document.getElementById('importHeadline');
      const det = document.getElementById('errorDetails');
      const list = document.getElementById('errorList');

      head.textContent = `Imported ${imported} ${imported===1?'order':'orders'}, skipped ${skipped} invalid ${skipped===1?'row':'rows'}.`;
      list.innerHTML = '';
      if(skipped>0 && errors && errors.length){
        det.classList.remove('hidden');
        list.innerHTML = errors.map(e=>`<li>${e}</li>`).join('');
      } else {
        det.open = false;
        list.innerHTML = '';
      }
      wrap.classList.remove('hidden');
    }

    // ---------- Rendering ----------
    function renderAll(){
      renderGrid();
      renderSummary();
      renderAlerts();
      runAssistant(false); // refresh headline quietly
    }

    function badgeForStatus(status){
      const base = 'inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold';
      switch(status){
        case 'waiting': return `${base} bg-amber-100 text-amber-800`;
        case 'in_progress': return `${base} bg-sky-100 text-sky-800`;
        case 'ready': return `${base} bg-emerald-100 text-emerald-800`;
        case 'cancelled': return `${base} bg-rose-100 text-rose-800`;
        default: return `${base} bg-coffee-100 text-coffee-800`;
      }
    }

    function renderGrid(){
      const grid = document.getElementById('ordersGrid');
      grid.innerHTML = '';

      if(orders.length===0){
        grid.innerHTML = `
          <div class="col-span-full">
            <div class="p-8 bg-white rounded-2xl border border-dashed border-coffee-200 text-center">
              <p class="font-semibold">No orders yet</p>
              <p class="text-sm text-coffee-600">Use “Add Demo Order” or “Upload CSV” to populate the board.</p>
            </div>
          </div>`;
        return;
      }

      for(const o of orders){
        const card = document.createElement('div');
        card.className = 'p-4 bg-white rounded-2xl border border-coffee-100 shadow-soft flex flex-col gap-3';
        const itemsStr = o.items.map(i=>i.name).join(', ');

        card.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div>
              <h3 class="font-extrabold text-lg">${o.customer}</h3>
              <p class="text-xs text-coffee-600">${o.payment} • <span title="${new Date(o.ts).toLocaleString()}">${timeSince(o.ts)}</span></p>
            </div>
            <div class="text-right">
              <div class="${badgeForStatus(o.status)}">${labelStatus(o.status)}</div>
              <div class="mt-1 text-sm font-bold">${currency(o.total)}</div>
            </div>
          </div>
          <p class="text-sm text-coffee-800 truncate-2" title="${itemsStr}">${itemsStr}</p>
          <div class="flex items-center gap-2">
            <label class="text-xs text-coffee-600">Update status</label>
            <select data-action="set-status" data-id="${o.id}" class="ml-auto px-3 py-2 rounded-xl border border-coffee-200 bg-white text-sm">
              ${['waiting','in_progress','ready','cancelled'].map(s=>`<option value="${s}" ${o.status===s?'selected':''}>${labelStatus(s)}</option>`).join('')}
            </select>
          </div>
          <div class="flex items-center gap-2">
            <button data-action="advance" data-id="${o.id}" class="flex-1 px-3 py-2 rounded-xl bg-coffee-700 text-white text-sm font-semibold hover:bg-coffee-800">${nextActionLabel(o.status)}</button>
            <button data-action="cancel" data-id="${o.id}" class="px-3 py-2 rounded-xl border border-rose-300 text-rose-700 text-sm hover:bg-rose-50">Cancel</button>
            <button data-action="remove" data-id="${o.id}" title="Remove card" class="px-3 py-2 rounded-xl border border-coffee-200 text-coffee-700 text-sm hover:bg-coffee-50">✕</button>
          </div>
        `;

        grid.appendChild(card);
      }

      // Wire actions
      grid.querySelectorAll('button, select').forEach(el=>{
        el.addEventListener('click', handleCardAction);
        el.addEventListener('change', handleCardAction);
      });
    }

    function nextActionLabel(status){
      if(status==='waiting') return 'Start → In Progress';
      if(status==='in_progress') return 'Mark Ready';
      if(status==='ready') return 'Revert → In Progress';
      if(status==='cancelled') return 'Reopen → Waiting';
      return 'Advance';
    }

    function labelStatus(s){
      return ({waiting:'Waiting', in_progress:'In Progress', ready:'Ready', cancelled:'Cancelled'})[s] || s;
    }

    function handleCardAction(e){
      const action = e.target.getAttribute('data-action');
      const id = e.target.getAttribute('data-id');
      if(!action){ // could be select change
        if(e.target.tagName==='SELECT' && e.target.getAttribute('data-action')==='set-status'){
          updateStatus(e.target.getAttribute('data-id'), e.target.value);
        }
        return;
      }
      if(action==='advance'){
        const o = orders.find(x=>x.id===id);
        if(!o) return;
        const next = (o.status==='waiting') ? 'in_progress'
                   : (o.status==='in_progress') ? 'ready'
                   : (o.status==='ready') ? 'in_progress'
                   : 'waiting';
        updateStatus(id, next);
      } else if(action==='cancel'){
        if(confirm('Cancel this order?')) cancelOrder(id);
      } else if(action==='remove'){
        if(confirm('Remove this order card from the board?')) removeOrder(id);
      }
    }

    function renderSummary(){
      const total = orders.length;
      const ready = orders.filter(o=>o.status==='ready').length;
      const pending = orders.filter(o=>o.status==='waiting' || o.status==='in_progress').length;
      const revenue = orders.filter(o=>o.status==='ready').reduce((a,o)=>a+Number(o.total||0),0);
      const aov = ready>0 ? revenue/ready : 0;

      document.getElementById('sumTotalOrders').textContent = total;
      document.getElementById('sumReadyPending').textContent = `${ready} ready • ${pending} pending`;
      document.getElementById('sumRevenue').textContent = currency(revenue);
      document.getElementById('sumAOV').textContent = `Avg order: ${currency(aov)}`;

      const sel = document.getElementById('autoRefresh');
      const val = Number(sel?.value || 0);
      document.getElementById('sumCurrentInterval').textContent = `Auto‑refresh: ${val? (val/1000+'s') : 'Off'}`;
    }

    function renderAlerts(){
      const alerts = [];
      const LONG_WAIT_MS = minutes(10);

      for(const o of orders){
        const waited = now()-o.ts;
        if((o.status==='waiting' || o.status==='in_progress') && waited > LONG_WAIT_MS){
          alerts.push({ type:'warning', message:`Long wait: ${o.customer} • ${labelStatus(o.status)} • ${timeSince(o.ts)}` });
        }
        if(o.items.length >= 6 && o.status!=='cancelled'){
          alerts.push({ type:'info', message:`Large group: ${o.customer} • ${o.items.length} items` });
        }
        if(o.status==='cancelled'){
          alerts.push({ type:'danger', message:`Cancelled: ${o.customer} • ${currency(o.total)}` });
        }
      }

      const list = document.getElementById('alertsList');
      list.innerHTML = '';
      document.getElementById('alertCount').textContent = `${alerts.length} ${alerts.length===1?'issue':'issues'}`;

      if(alerts.length===0){
        list.innerHTML = `<div class="text-sm text-coffee-600">All clear. No alerts right now.</div>`;
        return;
      }

      for(const a of alerts.slice(0,12)){
        const color = a.type==='warning' ? 'amber' : a.type==='danger' ? 'rose' : 'sky';
        const item = document.createElement('div');
        item.className = `text-sm px-3 py-2 rounded-xl border bg-${color}-50 border-${color}-200 text-${color}-900`;
        item.textContent = a.message;
        list.appendChild(item);
      }
    }

    // ---------- Auto‑Refresh Simulation ----------
    function simulateProgress(){
      // move some orders forward probabilistically
      for(const o of orders){
        if(o.status==='waiting' && Math.random() < 0.35){
          o.status = 'in_progress';
        } else if(o.status==='in_progress' && Math.random() < 0.4){
          o.status = 'ready';
          o.readyAt = now();
        }
        // occasional cancellation when waiting > 12m
        if((o.status==='waiting' || o.status==='in_progress') && (now()-o.ts>minutes(12)) && Math.random()<0.05){
          o.status='cancelled';
          o.cancelledAt = now();
        }
      }
      persistAndRender();
    }

    function setAutoRefresh(ms){
      if(intervalId){ clearInterval(intervalId); intervalId=null; }
      if(ms>0){ intervalId = setInterval(simulateAndRefresh, ms); }
      renderSummary();
    }

    function simulateAndRefresh(){
      simulateProgress();
    }

    // ---------- Smart Assistant ----------
    function runAssistant(showPanel=true){
      const suggestion = generateSuggestions();
      const headline = document.getElementById('assistantHeadline');
      headline.textContent = suggestion.headline;
      if(showPanel){
        alert(`Smart Assistant\n\n• ${suggestion.headline}\n\n${suggestion.details.join('\n• ')}`);
      }
    }

    function generateSuggestions(){
      const pending = orders.filter(o=>o.status==='waiting' || o.status==='in_progress');
      const itemCounts = {};
      const drinkCounts = {}; const pastryCounts={}; const snackCounts={};
      for(const o of pending){
        for(const it of o.items){
          itemCounts[it.name] = (itemCounts[it.name]||0)+1;
          if(it.type==='drinks') drinkCounts[it.name]=(drinkCounts[it.name]||0)+1;
          if(it.type==='pastries') pastryCounts[it.name]=(pastryCounts[it.name]||0)+1;
          if(it.type==='snacks') snackCounts[it.name]=(snackCounts[it.name]||0)+1;
        }
      }
      const top = Object.entries(itemCounts).sort((a,b)=>b[1]-a[1])[0];
      const pastryTop = Object.entries(pastryCounts).sort((a,b)=>b[1]-a[1])[0];
      const drinkTop = Object.entries(drinkCounts).sort((a,b)=>b[1]-a[1])[0];

      const cancelledRecently = orders.filter(o=>o.status==='cancelled' && (now()-(o.cancelledAt||o.ts))<minutes(30)).length;
      const longWaits = orders.filter(o=> (o.status==='waiting' || o.status==='in_progress') && (now()-o.ts)>minutes(10)).length;

      const details = [];
      if(pastryTop && pastryTop[1] >= 4) details.push(`Consider prepping more ${pastryTop[0]} — ${pastryTop[1]} in queue.`);
      if(drinkTop && drinkTop[1] >= 6) details.push(`Brew ahead for ${drinkTop[0]} — ${drinkTop[1]} queued.`);
      if(longWaits >= 3) details.push(`There are ${longWaits} long‑waiting orders (>10m). Rebalance staff to the bar/oven.`);
      if(cancelledRecently >= 2) details.push(`${cancelledRecently} cancellations in the last 30m. Check wait times and communication.`);
      if(details.length===0){ details.push('Everything looks balanced. Keep up the tempo!'); }

      const headline = top ? `Focus on “${top[0]}” — ${top[1]} pending` : 'No active bottlenecks detected';
      return { headline, details };
    }

    // ---------- Event Wiring ----------
    document.getElementById('addOrderBtn').addEventListener('click', ()=> addDemoOrder());
    document.getElementById('add5Btn').addEventListener('click', ()=> addMany(5));

    const selDesktop = document.getElementById('autoRefresh');
    const selMobile  = document.getElementById('autoRefreshMobile');

    function syncAutoRefreshSelects(val){
      if(selDesktop) selDesktop.value = String(val);
      if(selMobile) selMobile.value = String(val);
      setAutoRefresh(Number(val));
    }

    selDesktop?.addEventListener('change', (e)=> syncAutoRefreshSelects(e.target.value));
    selMobile?.addEventListener('change', (e)=> syncAutoRefreshSelects(e.target.value));

    document.getElementById('refreshNow').addEventListener('click', simulateAndRefresh);
    document.getElementById('refreshNowMobile').addEventListener('click', simulateAndRefresh);
    document.getElementById('runAssistant').addEventListener('click', ()=> runAssistant(true));

    // Upload CSV wiring
    const csvInput = document.getElementById('csvInput');
    document.getElementById('uploadCsvBtn').addEventListener('click', ()=> csvInput.click());
    csvInput.addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file){ return; }
      if(!file.name.toLowerCase().endsWith('.csv')){
        showImportToast(0, 0, ['Please select a .csv file.']);
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev)=> importCSVText(String(ev.target?.result||''));
      reader.onerror = ()=> showImportToast(0, 0, ['Failed to read file.']);
      reader.readAsText(file);
      // reset so same file can be re-selected
      e.target.value = '';
    });

    // Reset Data
    document.getElementById('resetDataBtn').addEventListener('click', ()=>{
      if(confirm('Reset to default demo dataset? This will clear imported orders.')){
        orders = [];
        localStorage.removeItem('orders_v2_csv');
        addMany(6);
        persistAndRender();
        showImportToast(0,0,['Data reset to default demo orders.']);
      }
    });

    // Import toast dismiss
    document.getElementById('dismissToast').addEventListener('click', ()=>{
      document.getElementById('importToast').classList.add('hidden');
    });

    // ---------- Bootstrap ----------
    (function init(){
      if(orders.length===0){ addMany(6); }
      syncAutoRefreshSelects(10000); // default 10s
      renderAll();
    })();
  </script>
</body>
</html>
